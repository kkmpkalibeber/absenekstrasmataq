<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Manajemen Ekstrakurikuler</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tab-active {
            background-color: #3b82f6;
            color: white;
        }
        
        .tab-inactive {
            background-color: #f3f4f6;
            color: #6b7280;
        }
        
        .status-h { background-color: #10b981; }
        .status-i { background-color: #f59e0b; }
        .status-s { background-color: #ef4444; }
        .status-a { background-color: #6b7280; }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="bg-gray-50 min-h-full"><!-- Header -->
  <header class="bg-white shadow-sm border-b">
   <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center h-16">
     <div>
      <h1 id="app-title" class="text-2xl font-bold text-gray-900">Sistem Manajemen Ekstrakurikuler</h1>
      <p id="school-name" class="text-sm text-gray-600">SMA TAKHASSUS AL QURAN WONOSOBO</p>
     </div>
     <div class="flex items-center space-x-4">
      <div id="connection-status" class="flex items-center space-x-2">
       <div class="w-3 h-3 bg-gray-400 rounded-full"></div><span class="text-sm text-gray-600">Menghubungkan...</span>
      </div><button id="test-connection" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"> Test Koneksi </button>
     </div>
    </div>
   </div>
  </header><!-- Navigation Tabs -->
  <nav class="bg-white border-b">
   <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex space-x-8"><button class="tab-button tab-active px-4 py-3 text-sm font-medium border-b-2 border-blue-600" data-tab="anggota"> üë• Data Anggota </button> <button class="tab-button tab-inactive px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:border-gray-300" data-tab="absensi"> üìÖ Absensi </button> <button class="tab-button tab-inactive px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:border-gray-300" data-tab="penilaian"> üìù Penilaian </button> <button class="tab-button tab-inactive px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:border-gray-300" data-tab="laporan"> üìä Laporan </button>
    </div>
   </div>
  </nav><!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"><!-- Loading Overlay -->
   <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg flex items-center space-x-3">
     <div class="loading-spinner"></div><span>Memproses data...</span>
    </div>
   </div><!-- Notification -->
   <div id="notification" class="hidden mb-6 p-4 rounded-lg"></div><!-- Data Anggota Tab -->
   <div id="tab-anggota" class="tab-content">
    <div class="bg-white rounded-lg shadow-sm">
     <div class="p-6 border-b border-gray-200">
      <div class="flex justify-between items-center mb-4">
       <h2 class="text-xl font-semibold text-gray-900">Data Anggota Ekstrakurikuler</h2><button id="add-anggota-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"> + Tambah Anggota </button>
      </div><!-- Search and Filter -->
      <div class="flex flex-col sm:flex-row gap-4 mb-4"><input type="text" id="search-anggota" placeholder="Cari nama anggota..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> <select id="filter-kelas" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"> <option value="">Semua Kelas</option> </select> <select id="filter-ekstra" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"> <option value="">Semua Ekstrakurikuler</option> </select>
      </div>
     </div><!-- Anggota Table -->
     <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
       <thead class="bg-gray-50">
        <tr>
         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ekstrakurikuler</th>
         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
        </tr>
       </thead>
       <tbody id="anggota-table-body" class="bg-white divide-y divide-gray-200"><!-- Data will be loaded here -->
       </tbody>
      </table>
     </div><!-- Pagination -->
     <div id="anggota-pagination" class="px-6 py-3 border-t border-gray-200 flex items-center justify-between">
      <div class="text-sm text-gray-700">
       Menampilkan <span id="anggota-showing">0</span> dari <span id="anggota-total">0</span> data
      </div>
      <div class="flex space-x-2"><button id="anggota-prev" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50" disabled>Sebelumnya</button> <button id="anggota-next" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50" disabled>Selanjutnya</button>
      </div>
     </div>
    </div>
   </div><!-- Data Absensi Tab -->
   <div id="tab-absensi" class="tab-content hidden">
    <div class="bg-white rounded-lg shadow-sm">
     <div class="p-6 border-b border-gray-200">
      <div class="flex justify-between items-center mb-4">
       <h2 class="text-xl font-semibold text-gray-900">Data Absensi</h2>
       <div class="flex space-x-2"><button id="add-absensi-batch-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors"> üìã Absensi Batch </button> <button id="add-absensi-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"> + Tambah Absensi </button>
       </div>
      </div><!-- Search and Filter -->
      <div class="flex flex-col sm:flex-row gap-4 mb-4"><input type="text" id="search-absensi" placeholder="Cari nama siswa atau ekstrakurikuler..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> <input type="date" id="filter-tanggal" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"> <select id="filter-status" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"> <option value="">Semua Status</option> <option value="H">H - Hadir</option> <option value="S">S - Sakit</option> <option value="I">I - Izin</option> <option value="A">A - Alpha</option> </select>
      </div>
     </div><!-- Absensi Table -->
     <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
       <thead class="bg-gray-50">
        <tr>
         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ekstrakurikuler</th>
         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
        </tr>
       </thead>
       <tbody id="absensi-table-body" class="bg-white divide-y divide-gray-200"><!-- Data will be loaded here -->
       </tbody>
      </table>
     </div><!-- Pagination -->
     <div id="absensi-pagination" class="px-6 py-3 border-t border-gray-200 flex items-center justify-between">
      <div class="text-sm text-gray-700">
       Menampilkan <span id="absensi-showing">0</span> dari <span id="absensi-total">0</span> data
      </div>
      <div class="flex space-x-2"><button id="absensi-prev" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50" disabled>Sebelumnya</button> <button id="absensi-next" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50" disabled>Selanjutnya</button>
      </div>
     </div>
    </div>
   </div><!-- Data Penilaian Tab -->
   <div id="tab-penilaian" class="tab-content hidden">
    <div class="bg-white rounded-lg shadow-sm">
     <div class="p-6 border-b border-gray-200">
      <div class="flex justify-between items-center mb-4">
       <h2 class="text-xl font-semibold text-gray-900">Data Penilaian</h2>
       <div class="flex space-x-2"><button id="add-penilaian-batch-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors"> üìã Penilaian Batch </button> <button id="add-penilaian-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"> + Tambah Penilaian </button>
       </div>
      </div><!-- Search and Filter -->
      <div class="flex flex-col sm:flex-row gap-4 mb-4"><input type="text" id="search-penilaian" placeholder="Cari nama siswa..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> <select id="filter-penilaian-kelas" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"> <option value="">Semua Kelas</option> </select> <select id="filter-penilaian-ekstra" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"> <option value="">Semua Ekstrakurikuler</option> </select>
      </div>
     </div><!-- Penilaian Table -->
     <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
       <thead class="bg-gray-50">
        <tr>
         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ekstrakurikuler</th>
         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nilai</th>
         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th>
         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
        </tr>
       </thead>
       <tbody id="penilaian-table-body" class="bg-white divide-y divide-gray-200"><!-- Data will be loaded here -->
       </tbody>
      </table>
     </div><!-- Pagination -->
     <div id="penilaian-pagination" class="px-6 py-3 border-t border-gray-200 flex items-center justify-between">
      <div class="text-sm text-gray-700">
       Menampilkan <span id="penilaian-showing">0</span> dari <span id="penilaian-total">0</span> data
      </div>
      <div class="flex space-x-2"><button id="penilaian-prev" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50" disabled>Sebelumnya</button> <button id="penilaian-next" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50" disabled>Selanjutnya</button>
      </div>
     </div>
    </div>
   </div><!-- Data Laporan Tab -->
   <div id="tab-laporan" class="tab-content hidden">
    <div class="bg-white rounded-lg shadow-sm">
     <div class="p-6 border-b border-gray-200">
      <div class="flex justify-between items-center mb-4">
       <h2 class="text-xl font-semibold text-gray-900">Laporan Rekap Kehadiran</h2><button id="export-laporan-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors"> üìä Export ke Excel </button>
      </div><!-- Filter Laporan -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
       <div><label class="block text-sm font-medium text-gray-700 mb-1">Filter Berdasarkan</label> <select id="laporan-filter-type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"> <option value="kelas">Berdasarkan Kelas</option> <option value="ekstra">Berdasarkan Ekstrakurikuler</option> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-1">Pilih Kelas/Ekstra</label> <select id="laporan-filter-value" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"> <option value="">Pilih...</option> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Mulai</label> <input type="date" id="laporan-tanggal-mulai" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Akhir</label> <input type="date" id="laporan-tanggal-akhir" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
       </div>
      </div>
      <div class="flex justify-between items-center"><button id="generate-laporan-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors"> üîç Generate Laporan </button>
       <div id="laporan-info" class="text-sm text-gray-600"></div>
      </div>
     </div><!-- Laporan Table -->
     <div id="laporan-table-container" class="hidden">
      <div class="overflow-x-auto">
       <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50" id="laporan-table-head"><!-- Dynamic headers will be inserted here -->
        </thead>
        <tbody id="laporan-table-body" class="bg-white divide-y divide-gray-200"><!-- Data will be loaded here -->
        </tbody>
       </table>
      </div><!-- Pagination -->
      <div id="laporan-pagination" class="px-6 py-3 border-t border-gray-200 flex items-center justify-between">
       <div class="text-sm text-gray-700">
        Menampilkan <span id="laporan-showing">0</span> dari <span id="laporan-total">0</span> data
       </div>
       <div class="flex space-x-2"><button id="laporan-prev" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50" disabled>Sebelumnya</button> <button id="laporan-next" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50" disabled>Selanjutnya</button>
       </div>
      </div>
     </div><!-- Empty State -->
     <div id="laporan-empty-state" class="p-8 text-center text-gray-500">
      <div class="text-4xl mb-4">
       üìä
      </div>
      <h3 class="text-lg font-medium text-gray-900 mb-2">Belum Ada Laporan</h3>
      <p class="text-sm">Pilih filter dan klik "Generate Laporan" untuk melihat rekap kehadiran</p>
     </div>
    </div>
   </div>
  </main><!-- Modal Container -->
  <div id="modal-container"></div>
  <script>
        // Configuration
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyhHORJKdEt2GNh37-WqL7n-K2T43SZ6Z8uJz0HVluggfXFa5VN3udq9GyCiZZ4cPD1ig/exec';
        
        // Default configuration
        const defaultConfig = {
            app_title: 'Sistem Manajemen Ekstrakurikuler',
            school_name: 'SMA Negeri 1',
            primary_color: '#3b82f6',
            secondary_color: '#f3f4f6',
            text_color: '#1f2937',
            success_color: '#10b981',
            warning_color: '#f59e0b'
        };

        // Global state
        let currentTab = 'anggota';
        let anggotaData = [];
        let absensiData = [];
        let penilaianData = [];
        let filteredAnggotaData = [];
        let filteredAbsensiData = [];
        let filteredPenilaianData = [];
        
        // Pagination state
        const ITEMS_PER_PAGE = 10;
        let currentAnggotaPage = 1;
        let currentAbsensiPage = 1;
        let currentPenilaianPage = 1;
        let currentLaporanPage = 1;
        
        // Laporan data
        let laporanData = [];
        let filteredLaporanData = [];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            testConnection();
        });

        // Initialize Element SDK
        if (window.elementSdk) {
            window.elementSdk.init({
                defaultConfig: defaultConfig,
                onConfigChange: async (config) => {
                    document.getElementById('app-title').textContent = config.app_title || defaultConfig.app_title;
                    document.getElementById('school-name').textContent = config.school_name || defaultConfig.school_name;
                    
                    // Update colors
                    const primaryColor = config.primary_color || defaultConfig.primary_color;
                    const secondaryColor = config.secondary_color || defaultConfig.secondary_color;
                    const textColor = config.text_color || defaultConfig.text_color;
                    
                    document.documentElement.style.setProperty('--primary-color', primaryColor);
                    document.documentElement.style.setProperty('--secondary-color', secondaryColor);
                    document.documentElement.style.setProperty('--text-color', textColor);
                },
                mapToCapabilities: (config) => ({
                    recolorables: [
                        {
                            get: () => config.primary_color || defaultConfig.primary_color,
                            set: (value) => {
                                config.primary_color = value;
                                window.elementSdk.setConfig({ primary_color: value });
                            }
                        },
                        {
                            get: () => config.secondary_color || defaultConfig.secondary_color,
                            set: (value) => {
                                config.secondary_color = value;
                                window.elementSdk.setConfig({ secondary_color: value });
                            }
                        },
                        {
                            get: () => config.text_color || defaultConfig.text_color,
                            set: (value) => {
                                config.text_color = value;
                                window.elementSdk.setConfig({ text_color: value });
                            }
                        }
                    ],
                    borderables: [],
                    fontEditable: undefined,
                    fontSizeable: undefined
                }),
                mapToEditPanelValues: (config) => new Map([
                    ['app_title', config.app_title || defaultConfig.app_title],
                    ['school_name', config.school_name || defaultConfig.school_name]
                ])
            });
        }

        function initializeApp() {
            // Set initial tab
            showTab('anggota');
        }

        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    const tab = button.getAttribute('data-tab');
                    showTab(tab);
                });
            });

            // Test connection button
            document.getElementById('test-connection').addEventListener('click', testConnection);

            // Add buttons
            document.getElementById('add-anggota-btn').addEventListener('click', () => showAnggotaModal());
            document.getElementById('add-absensi-btn').addEventListener('click', () => showAbsensiModal());
            document.getElementById('add-absensi-batch-btn').addEventListener('click', () => showAbsensiBatchModal());
            document.getElementById('add-penilaian-btn').addEventListener('click', () => showPenilaianModal());
            document.getElementById('add-penilaian-batch-btn').addEventListener('click', () => showPenilaianBatchModal());

            // Search and filter
            document.getElementById('search-anggota').addEventListener('input', filterAnggotaData);
            document.getElementById('filter-kelas').addEventListener('change', filterAnggotaData);
            document.getElementById('filter-ekstra').addEventListener('change', filterAnggotaData);

            document.getElementById('search-absensi').addEventListener('input', filterAbsensiData);
            document.getElementById('filter-tanggal').addEventListener('change', filterAbsensiData);
            document.getElementById('filter-status').addEventListener('change', filterAbsensiData);

            document.getElementById('search-penilaian').addEventListener('input', filterPenilaianData);
            document.getElementById('filter-penilaian-kelas').addEventListener('change', filterPenilaianData);
            document.getElementById('filter-penilaian-ekstra').addEventListener('change', filterPenilaianData);

            // Pagination
            document.getElementById('anggota-prev').addEventListener('click', () => changeAnggotaPage(-1));
            document.getElementById('anggota-next').addEventListener('click', () => changeAnggotaPage(1));
            document.getElementById('absensi-prev').addEventListener('click', () => changeAbsensiPage(-1));
            document.getElementById('absensi-next').addEventListener('click', () => changeAbsensiPage(1));
            document.getElementById('penilaian-prev').addEventListener('click', () => changePenilaianPage(-1));
            document.getElementById('penilaian-next').addEventListener('click', () => changePenilaianPage(1));
            document.getElementById('laporan-prev').addEventListener('click', () => changeLaporanPage(-1));
            document.getElementById('laporan-next').addEventListener('click', () => changeLaporanPage(1));

            // Laporan events
            document.getElementById('laporan-filter-type').addEventListener('change', updateLaporanFilterOptions);
            document.getElementById('generate-laporan-btn').addEventListener('click', generateLaporan);
            document.getElementById('export-laporan-btn').addEventListener('click', exportLaporan);
        }

        function showTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                if (button.getAttribute('data-tab') === tabName) {
                    button.className = 'tab-button tab-active px-4 py-3 text-sm font-medium border-b-2 border-blue-600';
                } else {
                    button.className = 'tab-button tab-inactive px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:border-gray-300';
                }
            });

            // Show/hide tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');

            currentTab = tabName;

            // Load data for the current tab
            if (tabName === 'anggota') {
                loadAnggotaData();
            } else if (tabName === 'absensi') {
                loadAbsensiData();
            } else if (tabName === 'penilaian') {
                loadPenilaianData();
            } else if (tabName === 'laporan') {
                loadLaporanData();
            }
        }

        // API Functions
        async function makeAPICall(action, params = {}) {
            try {
                showLoading(true);
                
                const url = new URL(SCRIPT_URL);
                url.searchParams.append('action', action);
                
                Object.keys(params).forEach(key => {
                    if (params[key] !== null && params[key] !== undefined) {
                        url.searchParams.append(key, params[key]);
                    }
                });

                const response = await fetch(url.toString());
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message || result.error || 'Unknown error');
                }
                
                return result;
            } catch (error) {
                console.error('API Error:', error);
                showNotification('Error: ' + error.message, 'error');
                throw error;
            } finally {
                showLoading(false);
            }
        }

        async function testConnection() {
            try {
                const result = await makeAPICall('test');
                updateConnectionStatus(true, result.message);
                showNotification('Koneksi berhasil! ' + result.message, 'success');
            } catch (error) {
                updateConnectionStatus(false, 'Koneksi gagal');
                showNotification('Koneksi gagal: ' + error.message, 'error');
            }
        }

        function updateConnectionStatus(connected, message) {
            const statusElement = document.getElementById('connection-status');
            const dot = statusElement.querySelector('div');
            const text = statusElement.querySelector('span');
            
            if (connected) {
                dot.className = 'w-3 h-3 bg-green-500 rounded-full';
                text.textContent = 'Terhubung';
            } else {
                dot.className = 'w-3 h-3 bg-red-500 rounded-full';
                text.textContent = 'Terputus';
            }
        }

        // Data loading functions
        async function loadAnggotaData() {
            try {
                const result = await makeAPICall('getAnggota');
                anggotaData = result.data || [];
                updateFilterOptions();
                filterAnggotaData();
                showNotification(`Berhasil memuat ${anggotaData.length} data anggota`, 'success');
            } catch (error) {
                anggotaData = [];
                renderAnggotaTable([]);
            }
        }

        async function loadAbsensiData() {
            try {
                const result = await makeAPICall('getAbsensi');
                absensiData = result.data || [];
                filterAbsensiData();
                showNotification(`Berhasil memuat ${absensiData.length} data absensi`, 'success');
            } catch (error) {
                absensiData = [];
                renderAbsensiTable([]);
            }
        }

        async function loadPenilaianData() {
            try {
                const result = await makeAPICall('getPenilaian');
                penilaianData = result.data || [];
                updatePenilaianFilterOptions();
                filterPenilaianData();
                showNotification(`Berhasil memuat ${penilaianData.length} data penilaian`, 'success');
            } catch (error) {
                penilaianData = [];
                renderPenilaianTable([]);
            }
        }

        // Filter functions
        function updateFilterOptions() {
            const kelasSet = new Set();
            const ekstraSet = new Set();
            
            anggotaData.forEach(item => {
                if (item.kelas) kelasSet.add(item.kelas);
                if (item.ekstra) ekstraSet.add(item.ekstra);
            });

            updateSelectOptions('filter-kelas', Array.from(kelasSet).sort());
            updateSelectOptions('filter-ekstra', Array.from(ekstraSet).sort());
        }

        function updatePenilaianFilterOptions() {
            const kelasSet = new Set();
            const ekstraSet = new Set();
            
            penilaianData.forEach(item => {
                if (item.kelas) kelasSet.add(item.kelas);
                if (item.ekstra) ekstraSet.add(item.ekstra);
            });

            updateSelectOptions('filter-penilaian-kelas', Array.from(kelasSet).sort());
            updateSelectOptions('filter-penilaian-ekstra', Array.from(ekstraSet).sort());
        }

        function updateSelectOptions(selectId, options) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            
            // Keep the first option (All)
            const firstOption = select.children[0];
            select.innerHTML = '';
            select.appendChild(firstOption);
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
            
            select.value = currentValue;
        }

        function filterAnggotaData() {
            const searchTerm = document.getElementById('search-anggota').value.toLowerCase();
            const kelasFilter = document.getElementById('filter-kelas').value;
            const ekstraFilter = document.getElementById('filter-ekstra').value;

            filteredAnggotaData = anggotaData.filter(item => {
                const matchesSearch = item.nama.toLowerCase().includes(searchTerm);
                const matchesKelas = !kelasFilter || item.kelas === kelasFilter;
                const matchesEkstra = !ekstraFilter || item.ekstra === ekstraFilter;
                
                return matchesSearch && matchesKelas && matchesEkstra;
            });

            currentAnggotaPage = 1;
            renderAnggotaTable(filteredAnggotaData);
        }

        function filterAbsensiData() {
            const searchTerm = document.getElementById('search-absensi').value.toLowerCase();
            const tanggalFilter = document.getElementById('filter-tanggal').value;
            const statusFilter = document.getElementById('filter-status').value;

            filteredAbsensiData = absensiData.filter(item => {
                const matchesSearch = item.nama.toLowerCase().includes(searchTerm) || 
                                    item.ekstra.toLowerCase().includes(searchTerm);
                const matchesTanggal = !tanggalFilter || item.tanggal === tanggalFilter;
                const matchesStatus = !statusFilter || item.status === statusFilter;
                
                return matchesSearch && matchesTanggal && matchesStatus;
            });

            currentAbsensiPage = 1;
            renderAbsensiTable(filteredAbsensiData);
        }

        function filterPenilaianData() {
            const searchTerm = document.getElementById('search-penilaian').value.toLowerCase();
            const kelasFilter = document.getElementById('filter-penilaian-kelas').value;
            const ekstraFilter = document.getElementById('filter-penilaian-ekstra').value;

            filteredPenilaianData = penilaianData.filter(item => {
                const matchesSearch = item.nama.toLowerCase().includes(searchTerm);
                const matchesKelas = !kelasFilter || item.kelas === kelasFilter;
                const matchesEkstra = !ekstraFilter || item.ekstra === ekstraFilter;
                
                return matchesSearch && matchesKelas && matchesEkstra;
            });

            currentPenilaianPage = 1;
            renderPenilaianTable(filteredPenilaianData);
        }

        // Render functions
        function renderAnggotaTable(data) {
            // Sort data: first by kelas, then by nama
            const sortedData = [...data].sort((a, b) => {
                if (a.kelas !== b.kelas) {
                    return a.kelas.localeCompare(b.kelas);
                }
                return a.nama.localeCompare(b.nama);
            });
            
            const tbody = document.getElementById('anggota-table-body');
            const startIndex = (currentAnggotaPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const pageData = sortedData.slice(startIndex, endIndex);

            if (pageData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-6 py-8 text-center text-gray-500">
                            Tidak ada data anggota
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = pageData.map(item => `
                    <tr class="hover:bg-gray-50 fade-in">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.nama}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.kelas}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.ekstra}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editAnggota('${item.nama}', '${item.kelas}', '${item.ekstra}')" 
                                    class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                            <button onclick="deleteAnggota('${item.nama}', '${item.kelas}', '${item.ekstra}')" 
                                    class="text-red-600 hover:text-red-900">Hapus</button>
                        </td>
                    </tr>
                `).join('');
            }

            updateAnggotaPagination(data.length);
        }

        function renderAbsensiTable(data) {
            // Sort data: first by tanggal (newest first), then by kelas, then by nama
            const sortedData = [...data].sort((a, b) => {
                // Sort by date (newest first)
                if (a.tanggal !== b.tanggal) {
                    return new Date(b.tanggal) - new Date(a.tanggal);
                }
                // Then by kelas
                if (a.kelas !== b.kelas) {
                    return a.kelas.localeCompare(b.kelas);
                }
                // Then by nama
                return a.nama.localeCompare(b.nama);
            });
            
            const tbody = document.getElementById('absensi-table-body');
            const startIndex = (currentAbsensiPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const pageData = sortedData.slice(startIndex, endIndex);

            if (pageData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                            Tidak ada data absensi
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = pageData.map(item => {
                    // Format status display
                    const statusDisplay = {
                        'H': 'H',
                        'S': 'S', 
                        'I': 'I',
                        'A': 'A'
                    };
                    
                    return `
                    <tr class="hover:bg-gray-50 fade-in">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.tanggal}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.nama}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.kelas}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.ekstra}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full text-white status-${item.status.toLowerCase()}">
                                ${statusDisplay[item.status] || item.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editAbsensi('${item.tanggal}', '${item.ekstra}', '${item.kelas}', '${item.nama}', '${item.status}')" 
                                    class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                            <button onclick="deleteAbsensi('${item.tanggal}', '${item.ekstra}', '${item.kelas}', '${item.nama}')" 
                                    class="text-red-600 hover:text-red-900">Hapus</button>
                        </td>
                    </tr>
                `;}).join('');
            }

            updateAbsensiPagination(data.length);
        }

        function renderPenilaianTable(data) {
            // Sort data: first by kelas (natural sort for class numbers), then by nama
            const sortedData = [...data].sort((a, b) => {
                // Natural sort for kelas (handles XII IPA 1, XII IPA 2, etc.)
                if (a.kelas !== b.kelas) {
                    return a.kelas.localeCompare(b.kelas, undefined, { numeric: true, sensitivity: 'base' });
                }
                // Then sort by nama alphabetically
                return a.nama.localeCompare(b.nama, 'id', { sensitivity: 'base' });
            });
            
            const tbody = document.getElementById('penilaian-table-body');
            const startIndex = (currentPenilaianPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const pageData = sortedData.slice(startIndex, endIndex);

            if (pageData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                            Tidak ada data penilaian
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = pageData.map(item => `
                    <tr class="hover:bg-gray-50 fade-in">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.nama}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.kelas}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.ekstra}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-blue-600">${item.nilai}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${item.keterangan || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editPenilaian('${item.ekstra}', '${item.kelas}', '${item.nama}', '${item.nilai}', '${item.keterangan || ''}')" 
                                    class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                            <button onclick="deletePenilaian('${item.ekstra}', '${item.kelas}', '${item.nama}')" 
                                    class="text-red-600 hover:text-red-900">Hapus</button>
                        </td>
                    </tr>
                `).join('');
            }

            updatePenilaianPagination(data.length);
        }

        // Pagination functions
        function updateAnggotaPagination(totalItems) {
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            const startItem = (currentAnggotaPage - 1) * ITEMS_PER_PAGE + 1;
            const endItem = Math.min(currentAnggotaPage * ITEMS_PER_PAGE, totalItems);

            document.getElementById('anggota-showing').textContent = totalItems > 0 ? `${startItem}-${endItem}` : '0';
            document.getElementById('anggota-total').textContent = totalItems;

            document.getElementById('anggota-prev').disabled = currentAnggotaPage <= 1;
            document.getElementById('anggota-next').disabled = currentAnggotaPage >= totalPages;
        }

        function updateAbsensiPagination(totalItems) {
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            const startItem = (currentAbsensiPage - 1) * ITEMS_PER_PAGE + 1;
            const endItem = Math.min(currentAbsensiPage * ITEMS_PER_PAGE, totalItems);

            document.getElementById('absensi-showing').textContent = totalItems > 0 ? `${startItem}-${endItem}` : '0';
            document.getElementById('absensi-total').textContent = totalItems;

            document.getElementById('absensi-prev').disabled = currentAbsensiPage <= 1;
            document.getElementById('absensi-next').disabled = currentAbsensiPage >= totalPages;
        }

        function updatePenilaianPagination(totalItems) {
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            const startItem = (currentPenilaianPage - 1) * ITEMS_PER_PAGE + 1;
            const endItem = Math.min(currentPenilaianPage * ITEMS_PER_PAGE, totalItems);

            document.getElementById('penilaian-showing').textContent = totalItems > 0 ? `${startItem}-${endItem}` : '0';
            document.getElementById('penilaian-total').textContent = totalItems;

            document.getElementById('penilaian-prev').disabled = currentPenilaianPage <= 1;
            document.getElementById('penilaian-next').disabled = currentPenilaianPage >= totalPages;
        }

        function changeAnggotaPage(direction) {
            const totalPages = Math.ceil(filteredAnggotaData.length / ITEMS_PER_PAGE);
            const newPage = currentAnggotaPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentAnggotaPage = newPage;
                renderAnggotaTable(filteredAnggotaData);
            }
        }

        function changeAbsensiPage(direction) {
            const totalPages = Math.ceil(filteredAbsensiData.length / ITEMS_PER_PAGE);
            const newPage = currentAbsensiPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentAbsensiPage = newPage;
                renderAbsensiTable(filteredAbsensiData);
            }
        }

        function changePenilaianPage(direction) {
            const totalPages = Math.ceil(filteredPenilaianData.length / ITEMS_PER_PAGE);
            const newPage = currentPenilaianPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPenilaianPage = newPage;
                renderPenilaianTable(filteredPenilaianData);
            }
        }

        // Modal functions
        function showAnggotaModal(editData = null) {
            const isEdit = editData !== null;
            
            // Get existing kelas and ekstra options
            const kelasOptions = [...new Set(anggotaData.map(item => item.kelas))].sort();
            const ekstraOptions = [...new Set(anggotaData.map(item => item.ekstra))].sort();
            
            const modalHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg shadow-lg max-w-md w-full mx-4">
                        <div class="p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                                ${isEdit ? 'Edit Anggota' : 'Tambah Anggota Baru'}
                            </h3>
                            <form id="anggota-form">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama</label>
                                        <input type="text" id="anggota-nama" required
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                               value="${editData ? editData.nama : ''}">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                                        <div class="flex space-x-2">
                                            <select id="anggota-kelas-select" 
                                                    class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                                <option value="">Pilih Kelas Existing</option>
                                                ${kelasOptions.map(kelas => `<option value="${kelas}" ${editData && editData.kelas === kelas ? 'selected' : ''}>${kelas}</option>`).join('')}
                                            </select>
                                            <button type="button" id="new-kelas-btn" 
                                                    class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                                                Baru
                                            </button>
                                        </div>
                                        <input type="text" id="anggota-kelas-input" placeholder="Masukkan kelas baru..." 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent mt-2 hidden"
                                               value="${editData && !kelasOptions.includes(editData.kelas) ? editData.kelas : ''}">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Ekstrakurikuler</label>
                                        <div class="flex space-x-2">
                                            <select id="anggota-ekstra-select" 
                                                    class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                                <option value="">Pilih Ekstrakurikuler Existing</option>
                                                ${ekstraOptions.map(ekstra => `<option value="${ekstra}" ${editData && editData.ekstra === ekstra ? 'selected' : ''}>${ekstra}</option>`).join('')}
                                            </select>
                                            <button type="button" id="new-ekstra-btn" 
                                                    class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                                                Baru
                                            </button>
                                        </div>
                                        <input type="text" id="anggota-ekstra-input" placeholder="Masukkan ekstrakurikuler baru..." 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent mt-2 hidden"
                                               value="${editData && !ekstraOptions.includes(editData.ekstra) ? editData.ekstra : ''}">
                                    </div>
                                </div>
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="closeModal()" 
                                            class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                                        Batal
                                    </button>
                                    <button type="submit" 
                                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                        ${isEdit ? 'Update' : 'Simpan'}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('modal-container').innerHTML = modalHTML;

            // Setup dropdown toggle functionality
            document.getElementById('new-kelas-btn').addEventListener('click', () => {
                const select = document.getElementById('anggota-kelas-select');
                const input = document.getElementById('anggota-kelas-input');
                const btn = document.getElementById('new-kelas-btn');
                
                if (input.classList.contains('hidden')) {
                    input.classList.remove('hidden');
                    select.classList.add('hidden');
                    btn.textContent = 'Pilih';
                    input.focus();
                } else {
                    input.classList.add('hidden');
                    select.classList.remove('hidden');
                    btn.textContent = 'Baru';
                    input.value = '';
                }
            });

            document.getElementById('new-ekstra-btn').addEventListener('click', () => {
                const select = document.getElementById('anggota-ekstra-select');
                const input = document.getElementById('anggota-ekstra-input');
                const btn = document.getElementById('new-ekstra-btn');
                
                if (input.classList.contains('hidden')) {
                    input.classList.remove('hidden');
                    select.classList.add('hidden');
                    btn.textContent = 'Pilih';
                    input.focus();
                } else {
                    input.classList.add('hidden');
                    select.classList.remove('hidden');
                    btn.textContent = 'Baru';
                    input.value = '';
                }
            });

            // Show input if editing with new value
            if (editData) {
                if (!kelasOptions.includes(editData.kelas)) {
                    document.getElementById('new-kelas-btn').click();
                }
                if (!ekstraOptions.includes(editData.ekstra)) {
                    document.getElementById('new-ekstra-btn').click();
                }
            }

            document.getElementById('anggota-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const nama = document.getElementById('anggota-nama').value.trim();
                
                // Get kelas value from either select or input
                const kelasSelect = document.getElementById('anggota-kelas-select');
                const kelasInput = document.getElementById('anggota-kelas-input');
                const kelas = kelasInput.classList.contains('hidden') ? kelasSelect.value.trim() : kelasInput.value.trim();
                
                // Get ekstra value from either select or input
                const ekstraSelect = document.getElementById('anggota-ekstra-select');
                const ekstraInput = document.getElementById('anggota-ekstra-input');
                const ekstra = ekstraInput.classList.contains('hidden') ? ekstraSelect.value.trim() : ekstraInput.value.trim();

                if (!nama || !kelas || !ekstra) {
                    showNotification('Semua field harus diisi', 'error');
                    return;
                }

                try {
                    if (isEdit) {
                        await makeAPICall('updateAnggota', {
                            originalNama: editData.nama,
                            originalKelas: editData.kelas,
                            originalEkstra: editData.ekstra,
                            newNama: nama,
                            newKelas: kelas,
                            newEkstra: ekstra
                        });
                        showNotification('Data anggota berhasil diupdate', 'success');
                    } else {
                        await makeAPICall('addAnggota', {
                            nama: nama,
                            kelas: kelas,
                            ekstra: ekstra
                        });
                        showNotification('Anggota baru berhasil ditambahkan', 'success');
                    }
                    
                    closeModal();
                    loadAnggotaData();
                } catch (error) {
                    // Error already handled in makeAPICall
                }
            });
        }

        function showAbsensiModal(editData = null) {
            const isEdit = editData !== null;
            
            // Get unique ekstrakurikuler options
            const ekstraOptions = [...new Set(anggotaData.map(item => item.ekstra))].sort();
            
            const modalHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg shadow-lg max-w-md w-full mx-4">
                        <div class="p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                                ${isEdit ? 'Edit Absensi' : 'Tambah Absensi Baru'}
                            </h3>
                            <form id="absensi-form">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                                        <input type="date" id="absensi-tanggal" required
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                               value="${editData ? editData.tanggal : new Date().toISOString().split('T')[0]}">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Ekstrakurikuler</label>
                                        <select id="absensi-ekstra" required
                                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="">Pilih Ekstrakurikuler</option>
                                            ${ekstraOptions.map(ekstra => `<option value="${ekstra}" ${editData && editData.ekstra === ekstra ? 'selected' : ''}>${ekstra}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Siswa</label>
                                        <div class="relative">
                                            <input type="text" id="absensi-nama-search" placeholder="Cari nama siswa..." 
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                   value="${editData ? editData.nama : ''}" autocomplete="off">
                                            <div id="nama-dropdown" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-48 overflow-y-auto hidden">
                                                <!-- Dropdown options will be populated here -->
                                            </div>
                                        </div>
                                        <input type="hidden" id="absensi-nama" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                                        <input type="text" id="absensi-kelas" readonly
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600"
                                               value="${editData ? editData.kelas : ''}" placeholder="Kelas akan otomatis terisi">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                        <select id="absensi-status" required
                                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="H" ${!editData || editData.status === 'H' ? 'selected' : ''}>H - Hadir</option>
                                            <option value="S" ${editData && editData.status === 'S' ? 'selected' : ''}>S - Sakit</option>
                                            <option value="I" ${editData && editData.status === 'I' ? 'selected' : ''}>I - Izin</option>
                                            <option value="A" ${editData && editData.status === 'A' ? 'selected' : ''}>A - Alpha</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="closeModal()" 
                                            class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                                        Batal
                                    </button>
                                    <button type="submit" 
                                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                        ${isEdit ? 'Update' : 'Simpan'}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('modal-container').innerHTML = modalHTML;

            // Setup ekstrakurikuler change handler
            document.getElementById('absensi-ekstra').addEventListener('change', function() {
                const selectedEkstra = this.value;
                const namaSearch = document.getElementById('absensi-nama-search');
                const namaHidden = document.getElementById('absensi-nama');
                const kelasField = document.getElementById('absensi-kelas');
                
                // Reset nama and kelas when ekstra changes
                namaSearch.value = '';
                namaHidden.value = '';
                kelasField.value = '';
                
                // Hide dropdown
                document.getElementById('nama-dropdown').classList.add('hidden');
                
                if (selectedEkstra) {
                    namaSearch.placeholder = `Cari nama siswa di ${selectedEkstra}...`;
                } else {
                    namaSearch.placeholder = 'Pilih ekstrakurikuler terlebih dahulu';
                }
            });

            // Setup nama search functionality
            const namaSearch = document.getElementById('absensi-nama-search');
            const namaDropdown = document.getElementById('nama-dropdown');
            const namaHidden = document.getElementById('absensi-nama');
            const kelasField = document.getElementById('absensi-kelas');

            namaSearch.addEventListener('input', function() {
                const selectedEkstra = document.getElementById('absensi-ekstra').value;
                const searchTerm = this.value.toLowerCase().trim();
                
                // Clear hidden values when typing
                namaHidden.value = '';
                kelasField.value = '';
                
                if (!selectedEkstra) {
                    namaDropdown.classList.add('hidden');
                    namaDropdown.innerHTML = '<div class="px-3 py-2 text-gray-500 text-sm">Pilih ekstrakurikuler terlebih dahulu</div>';
                    return;
                }
                
                if (searchTerm.length === 0) {
                    namaDropdown.classList.add('hidden');
                    return;
                }
                
                // Filter anggota by selected ekstrakurikuler and search term
                const filteredAnggota = anggotaData.filter(item => 
                    item.ekstra === selectedEkstra && 
                    item.nama.toLowerCase().includes(searchTerm)
                );
                
                if (filteredAnggota.length > 0) {
                    namaDropdown.innerHTML = filteredAnggota.map(item => `
                        <div class="px-3 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0" 
                             data-nama="${item.nama}" data-kelas="${item.kelas}">
                            <div class="font-medium text-gray-900">${item.nama}</div>
                            <div class="text-sm text-gray-500">${item.kelas}</div>
                        </div>
                    `).join('');
                    namaDropdown.classList.remove('hidden');
                    
                    // Add click handlers to dropdown items
                    namaDropdown.querySelectorAll('[data-nama]').forEach(item => {
                        item.addEventListener('click', function() {
                            const nama = this.getAttribute('data-nama');
                            const kelas = this.getAttribute('data-kelas');
                            namaSearch.value = nama;
                            namaHidden.value = nama;
                            kelasField.value = kelas;
                            namaDropdown.classList.add('hidden');
                        });
                    });
                } else {
                    namaDropdown.innerHTML = '<div class="px-3 py-2 text-gray-500 text-sm">Tidak ada siswa yang ditemukan</div>';
                    namaDropdown.classList.remove('hidden');
                }
            });

            // Show all students when clicking on search field
            namaSearch.addEventListener('focus', function() {
                const selectedEkstra = document.getElementById('absensi-ekstra').value;
                
                if (selectedEkstra && this.value.trim() === '') {
                    const filteredAnggota = anggotaData.filter(item => item.ekstra === selectedEkstra);
                    
                    if (filteredAnggota.length > 0) {
                        namaDropdown.innerHTML = filteredAnggota.map(item => `
                            <div class="px-3 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0" 
                                 data-nama="${item.nama}" data-kelas="${item.kelas}">
                                <div class="font-medium text-gray-900">${item.nama}</div>
                                <div class="text-sm text-gray-500">${item.kelas}</div>
                            </div>
                        `).join('');
                        namaDropdown.classList.remove('hidden');
                        
                        // Add click handlers to dropdown items
                        namaDropdown.querySelectorAll('[data-nama]').forEach(item => {
                            item.addEventListener('click', function() {
                                const nama = this.getAttribute('data-nama');
                                const kelas = this.getAttribute('data-kelas');
                                namaSearch.value = nama;
                                namaHidden.value = nama;
                                kelasField.value = kelas;
                                namaDropdown.classList.add('hidden');
                            });
                        });
                    }
                }
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!namaSearch.contains(e.target) && !namaDropdown.contains(e.target)) {
                    namaDropdown.classList.add('hidden');
                }
            });

            // Set initial values for edit mode
            if (editData) {
                // Trigger ekstra change to setup the form
                setTimeout(() => {
                    document.getElementById('absensi-ekstra').dispatchEvent(new Event('change'));
                    // Set nama after ekstra is set
                    setTimeout(() => {
                        namaSearch.value = editData.nama;
                        namaHidden.value = editData.nama;
                        kelasField.value = editData.kelas;
                    }, 100);
                }, 100);
            }



            document.getElementById('absensi-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const tanggal = document.getElementById('absensi-tanggal').value;
                const nama = document.getElementById('absensi-nama').value.trim();
                const kelas = document.getElementById('absensi-kelas').value.trim();
                const ekstra = document.getElementById('absensi-ekstra').value.trim();
                const status = document.getElementById('absensi-status').value;

                if (!tanggal || !ekstra) {
                    showNotification('Tanggal dan ekstrakurikuler harus diisi', 'error');
                    return;
                }

                if (!nama || !kelas) {
                    showNotification('Silakan pilih nama siswa dari dropdown', 'error');
                    return;
                }

                if (!status) {
                    showNotification('Status absensi harus dipilih', 'error');
                    return;
                }

                try {
                    if (isEdit) {
                        await makeAPICall('updateAbsensi', {
                            originalTanggal: editData.tanggal,
                            originalEkstra: editData.ekstra,
                            originalKelas: editData.kelas,
                            originalNama: editData.nama,
                            newTanggal: tanggal,
                            newEkstra: ekstra,
                            newKelas: kelas,
                            newNama: nama,
                            newStatus: status
                        });
                        showNotification('Data absensi berhasil diupdate', 'success');
                    } else {
                        await makeAPICall('addAbsensi', {
                            tanggal: tanggal,
                            ekstra: ekstra,
                            kelas: kelas,
                            nama: nama,
                            status: status
                        });
                        showNotification('Absensi baru berhasil ditambahkan', 'success');
                    }
                    
                    closeModal();
                    loadAbsensiData();
                } catch (error) {
                    // Error already handled in makeAPICall
                }
            });
        }

        function showAbsensiBatchModal() {
            const modalHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg shadow-lg max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Absensi Batch</h3>
                            <form id="absensi-batch-form">
                                <div class="space-y-4">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                                            <input type="date" id="batch-tanggal" required
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                   value="${new Date().toISOString().split('T')[0]}">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Ekstrakurikuler</label>
                                            <input type="text" id="batch-ekstra" required
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Daftar Siswa (satu per baris)</label>
                                        <textarea id="batch-siswa" rows="8" required placeholder="Format: Nama,Kelas,Status&#10;Contoh:&#10;Ahmad Rizki,XII IPA 1,H&#10;Siti Nurhaliza,XII IPA 2,I"
                                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                        <p class="text-xs text-gray-500 mt-1">Status yang valid: H (Hadir), S (Sakit), I (Izin), A (Alpha)</p>
                                    </div>
                                </div>
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="closeModal()" 
                                            class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                                        Batal
                                    </button>
                                    <button type="submit" 
                                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                        Simpan Batch
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('modal-container').innerHTML = modalHTML;

            document.getElementById('absensi-batch-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const tanggal = document.getElementById('batch-tanggal').value;
                const ekstra = document.getElementById('batch-ekstra').value.trim();
                const siswaText = document.getElementById('batch-siswa').value.trim();

                if (!tanggal || !ekstra || !siswaText) {
                    showNotification('Semua field harus diisi', 'error');
                    return;
                }

                try {
                    const lines = siswaText.split('\n').filter(line => line.trim());
                    const absensiData = [];

                    for (let i = 0; i < lines.length; i++) {
                        const parts = lines[i].split(',').map(part => part.trim());
                        if (parts.length !== 3) {
                            showNotification(`Baris ${i + 1}: Format tidak valid. Gunakan format: Nama,Kelas,Status`, 'error');
                            return;
                        }

                        const [nama, kelas, status] = parts;
                        if (!['H', 'S', 'I', 'A'].includes(status)) {
                            showNotification(`Baris ${i + 1}: Status "${status}" tidak valid. Gunakan H, S, I, atau A`, 'error');
                            return;
                        }

                        absensiData.push({
                            tanggal: tanggal,
                            ekstra: ekstra,
                            kelas: kelas,
                            nama: nama,
                            status: status
                        });
                    }

                    await makeAPICall('addAbsensiBatch', {
                        absensiData: JSON.stringify(absensiData)
                    });
                    
                    showNotification(`Berhasil menambahkan ${absensiData.length} data absensi`, 'success');
                    closeModal();
                    loadAbsensiData();
                } catch (error) {
                    // Error already handled in makeAPICall
                }
            });
        }

        function showPenilaianModal(editData = null) {
            const isEdit = editData !== null;
            
            // Get unique ekstrakurikuler options
            const ekstraOptions = [...new Set(anggotaData.map(item => item.ekstra))].sort();
            
            const modalHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg shadow-lg max-w-md w-full mx-4">
                        <div class="p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                                ${isEdit ? 'Edit Penilaian' : 'Tambah Penilaian Baru'}
                            </h3>
                            <form id="penilaian-form">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Ekstrakurikuler</label>
                                        <select id="penilaian-ekstra" required
                                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="">Pilih Ekstrakurikuler</option>
                                            ${ekstraOptions.map(ekstra => `<option value="${ekstra}" ${editData && editData.ekstra === ekstra ? 'selected' : ''}>${ekstra}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Siswa</label>
                                        <div class="relative">
                                            <input type="text" id="penilaian-nama-search" placeholder="Cari nama siswa..." 
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                   value="${editData ? editData.nama : ''}" autocomplete="off">
                                            <div id="penilaian-nama-dropdown" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-48 overflow-y-auto hidden">
                                                <!-- Dropdown options will be populated here -->
                                            </div>
                                        </div>
                                        <input type="hidden" id="penilaian-nama" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                                        <input type="text" id="penilaian-kelas" readonly
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600"
                                               value="${editData ? editData.kelas : ''}" placeholder="Kelas akan otomatis terisi">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Nilai</label>
                                        <select id="penilaian-nilai" required
                                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="BAIK" ${!editData || editData.nilai === 'BAIK' ? 'selected' : ''}>BAIK</option>
                                            <option value="SANGAT BAIK" ${editData && editData.nilai === 'SANGAT BAIK' ? 'selected' : ''}>SANGAT BAIK</option>
                                            <option value="SEDANG" ${editData && editData.nilai === 'SEDANG' ? 'selected' : ''}>SEDANG</option>
                                            <option value="CUKUP" ${editData && editData.nilai === 'CUKUP' ? 'selected' : ''}>CUKUP</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Deskripsi/Keterangan</label>
                                        <textarea id="penilaian-keterangan" rows="5"
                                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                                  placeholder="Masukkan deskripsi atau keterangan penilaian...">${editData ? editData.keterangan || '' : ''}</textarea>
                                    </div>
                                </div>
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="closeModal()" 
                                            class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                                        Batal
                                    </button>
                                    <button type="submit" 
                                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                        ${isEdit ? 'Update' : 'Simpan'}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('modal-container').innerHTML = modalHTML;

            // Setup ekstrakurikuler change handler
            document.getElementById('penilaian-ekstra').addEventListener('change', function() {
                const selectedEkstra = this.value;
                const namaSearch = document.getElementById('penilaian-nama-search');
                const namaHidden = document.getElementById('penilaian-nama');
                const kelasField = document.getElementById('penilaian-kelas');
                
                // Reset nama and kelas when ekstra changes
                namaSearch.value = '';
                namaHidden.value = '';
                kelasField.value = '';
                
                // Hide dropdown
                document.getElementById('penilaian-nama-dropdown').classList.add('hidden');
                
                if (selectedEkstra) {
                    namaSearch.placeholder = `Cari nama siswa di ${selectedEkstra}...`;
                } else {
                    namaSearch.placeholder = 'Pilih ekstrakurikuler terlebih dahulu';
                }
            });

            // Setup nama search functionality
            const namaSearch = document.getElementById('penilaian-nama-search');
            const namaDropdown = document.getElementById('penilaian-nama-dropdown');
            const namaHidden = document.getElementById('penilaian-nama');
            const kelasField = document.getElementById('penilaian-kelas');

            namaSearch.addEventListener('input', function() {
                const selectedEkstra = document.getElementById('penilaian-ekstra').value;
                const searchTerm = this.value.toLowerCase().trim();
                
                // Clear hidden values when typing
                namaHidden.value = '';
                kelasField.value = '';
                
                if (!selectedEkstra) {
                    namaDropdown.classList.add('hidden');
                    namaDropdown.innerHTML = '<div class="px-3 py-2 text-gray-500 text-sm">Pilih ekstrakurikuler terlebih dahulu</div>';
                    return;
                }
                
                if (searchTerm.length === 0) {
                    namaDropdown.classList.add('hidden');
                    return;
                }
                
                // Filter anggota by selected ekstrakurikuler and search term
                const filteredAnggota = anggotaData.filter(item => 
                    item.ekstra === selectedEkstra && 
                    item.nama.toLowerCase().includes(searchTerm)
                );
                
                if (filteredAnggota.length > 0) {
                    namaDropdown.innerHTML = filteredAnggota.map(item => `
                        <div class="px-3 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0" 
                             data-nama="${item.nama}" data-kelas="${item.kelas}">
                            <div class="font-medium text-gray-900">${item.nama}</div>
                            <div class="text-sm text-gray-500">${item.kelas}</div>
                        </div>
                    `).join('');
                    namaDropdown.classList.remove('hidden');
                    
                    // Add click handlers to dropdown items
                    namaDropdown.querySelectorAll('[data-nama]').forEach(item => {
                        item.addEventListener('click', function() {
                            const nama = this.getAttribute('data-nama');
                            const kelas = this.getAttribute('data-kelas');
                            namaSearch.value = nama;
                            namaHidden.value = nama;
                            kelasField.value = kelas;
                            namaDropdown.classList.add('hidden');
                        });
                    });
                } else {
                    namaDropdown.innerHTML = '<div class="px-3 py-2 text-gray-500 text-sm">Tidak ada siswa yang ditemukan</div>';
                    namaDropdown.classList.remove('hidden');
                }
            });

            // Show all students when clicking on search field
            namaSearch.addEventListener('focus', function() {
                const selectedEkstra = document.getElementById('penilaian-ekstra').value;
                
                if (selectedEkstra && this.value.trim() === '') {
                    const filteredAnggota = anggotaData.filter(item => item.ekstra === selectedEkstra);
                    
                    if (filteredAnggota.length > 0) {
                        namaDropdown.innerHTML = filteredAnggota.map(item => `
                            <div class="px-3 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0" 
                                 data-nama="${item.nama}" data-kelas="${item.kelas}">
                                <div class="font-medium text-gray-900">${item.nama}</div>
                                <div class="text-sm text-gray-500">${item.kelas}</div>
                            </div>
                        `).join('');
                        namaDropdown.classList.remove('hidden');
                        
                        // Add click handlers to dropdown items
                        namaDropdown.querySelectorAll('[data-nama]').forEach(item => {
                            item.addEventListener('click', function() {
                                const nama = this.getAttribute('data-nama');
                                const kelas = this.getAttribute('data-kelas');
                                namaSearch.value = nama;
                                namaHidden.value = nama;
                                kelasField.value = kelas;
                                namaDropdown.classList.add('hidden');
                            });
                        });
                    }
                }
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!namaSearch.contains(e.target) && !namaDropdown.contains(e.target)) {
                    namaDropdown.classList.add('hidden');
                }
            });

            // Set initial values for edit mode
            if (editData) {
                // Trigger ekstra change to setup the form
                setTimeout(() => {
                    document.getElementById('penilaian-ekstra').dispatchEvent(new Event('change'));
                    // Set nama after ekstra is set
                    setTimeout(() => {
                        namaSearch.value = editData.nama;
                        namaHidden.value = editData.nama;
                        kelasField.value = editData.kelas;
                    }, 100);
                }, 100);
            }

            document.getElementById('penilaian-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const nama = document.getElementById('penilaian-nama').value.trim();
                const kelas = document.getElementById('penilaian-kelas').value.trim();
                const ekstra = document.getElementById('penilaian-ekstra').value.trim();
                const nilai = document.getElementById('penilaian-nilai').value;
                const keterangan = document.getElementById('penilaian-keterangan').value.trim();

                if (!ekstra) {
                    showNotification('Ekstrakurikuler harus dipilih', 'error');
                    return;
                }

                if (!nama || !kelas) {
                    showNotification('Silakan pilih nama siswa dari dropdown', 'error');
                    return;
                }

                if (!nilai) {
                    showNotification('Nilai harus dipilih', 'error');
                    return;
                }

                try {
                    if (isEdit) {
                        await makeAPICall('updatePenilaian', {
                            originalEkstra: editData.ekstra,
                            originalKelas: editData.kelas,
                            originalNama: editData.nama,
                            newEkstra: ekstra,
                            newKelas: kelas,
                            newNama: nama,
                            newNilai: nilai,
                            newKeterangan: keterangan
                        });
                        showNotification('Data penilaian berhasil diupdate', 'success');
                    } else {
                        await makeAPICall('addPenilaian', {
                            ekstra: ekstra,
                            kelas: kelas,
                            nama: nama,
                            nilai: nilai,
                            keterangan: keterangan
                        });
                        showNotification('Penilaian baru berhasil ditambahkan', 'success');
                    }
                    
                    closeModal();
                    loadPenilaianData();
                } catch (error) {
                    // Error already handled in makeAPICall
                }
            });
        }

        function showPenilaianBatchModal() {
            const modalHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg shadow-lg max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Penilaian Batch</h3>
                            <form id="penilaian-batch-form">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Ekstrakurikuler</label>
                                        <input type="text" id="batch-penilaian-ekstra" required
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Daftar Penilaian (satu per baris)</label>
                                        <textarea id="batch-penilaian-siswa" rows="8" required placeholder="Format: Nama,Kelas,Nilai,Keterangan&#10;Contoh:&#10;Ahmad Rizki,XII IPA 1,BAIK,Siswa aktif dan disiplin&#10;Siti Nurhaliza,XII IPA 2,SANGAT BAIK,Prestasi sangat memuaskan"
                                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                        <p class="text-xs text-gray-500 mt-1">Nilai yang valid: SANGAT BAIK, BAIK, SEDANG, CUKUP. Keterangan bisa dikosongkan.</p>
                                    </div>
                                </div>
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="closeModal()" 
                                            class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                                        Batal
                                    </button>
                                    <button type="submit" 
                                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                        Simpan Batch
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('modal-container').innerHTML = modalHTML;

            document.getElementById('penilaian-batch-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const ekstra = document.getElementById('batch-penilaian-ekstra').value.trim();
                const siswaText = document.getElementById('batch-penilaian-siswa').value.trim();

                if (!ekstra || !siswaText) {
                    showNotification('Ekstrakurikuler dan daftar penilaian harus diisi', 'error');
                    return;
                }

                try {
                    const lines = siswaText.split('\n').filter(line => line.trim());
                    const penilaianData = [];

                    for (let i = 0; i < lines.length; i++) {
                        const parts = lines[i].split(',').map(part => part.trim());
                        if (parts.length < 3 || parts.length > 4) {
                            showNotification(`Baris ${i + 1}: Format tidak valid. Gunakan format: Nama,Kelas,Nilai,Keterangan`, 'error');
                            return;
                        }

                        const [nama, kelas, nilai, keterangan = ''] = parts;
                        
                        if (!['SANGAT BAIK', 'BAIK', 'SEDANG', 'CUKUP'].includes(nilai)) {
                            showNotification(`Baris ${i + 1}: Nilai "${nilai}" tidak valid. Gunakan SANGAT BAIK, BAIK, SEDANG, atau CUKUP`, 'error');
                            return;
                        }
                        
                        penilaianData.push({
                            ekstra: ekstra,
                            kelas: kelas,
                            nama: nama,
                            nilai: nilai,
                            keterangan: keterangan
                        });
                    }

                    await makeAPICall('addPenilaianBatch', {
                        penilaianData: JSON.stringify(penilaianData)
                    });
                    
                    showNotification(`Berhasil menambahkan ${penilaianData.length} data penilaian`, 'success');
                    closeModal();
                    loadPenilaianData();
                } catch (error) {
                    // Error already handled in makeAPICall
                }
            });
        }

        function closeModal() {
            document.getElementById('modal-container').innerHTML = '';
        }

        // CRUD functions
        function editAnggota(nama, kelas, ekstra) {
            showAnggotaModal({ nama, kelas, ekstra });
        }

        async function deleteAnggota(nama, kelas, ekstra) {
            // Show inline confirmation instead of browser confirm
            const confirmModal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg shadow-lg max-w-md w-full mx-4">
                        <div class="p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Konfirmasi Hapus</h3>
                            <p class="text-gray-600 mb-6">Apakah Anda yakin ingin menghapus anggota <strong>${nama}</strong> dari kelas <strong>${kelas}</strong>?</p>
                            <div class="flex justify-end space-x-3">
                                <button onclick="closeModal()" 
                                        class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                                    Batal
                                </button>
                                <button onclick="confirmDeleteAnggota('${nama}', '${kelas}', '${ekstra}')" 
                                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                                    Hapus
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-container').innerHTML = confirmModal;
        }

        async function confirmDeleteAnggota(nama, kelas, ekstra) {
            closeModal();
            
            try {
                await makeAPICall('deleteAnggota', {
                    nama: nama,
                    kelas: kelas,
                    ekstra: ekstra
                });
                showNotification('Anggota berhasil dihapus', 'success');
                loadAnggotaData();
            } catch (error) {
                // Error already handled in makeAPICall
            }
        }

        function editAbsensi(tanggal, ekstra, kelas, nama, status) {
            showAbsensiModal({ tanggal, ekstra, kelas, nama, status });
        }

        async function deleteAbsensi(tanggal, ekstra, kelas, nama) {
            // Show inline confirmation instead of browser confirm
            const confirmModal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg shadow-lg max-w-md w-full mx-4">
                        <div class="p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Konfirmasi Hapus</h3>
                            <p class="text-gray-600 mb-6">Apakah Anda yakin ingin menghapus data absensi <strong>${nama}</strong> pada tanggal <strong>${tanggal}</strong>?</p>
                            <div class="flex justify-end space-x-3">
                                <button onclick="closeModal()" 
                                        class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                                    Batal
                                </button>
                                <button onclick="confirmDeleteAbsensi('${tanggal}', '${ekstra}', '${kelas}', '${nama}')" 
                                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                                    Hapus
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-container').innerHTML = confirmModal;
        }

        async function confirmDeleteAbsensi(tanggal, ekstra, kelas, nama) {
            closeModal();
            
            try {
                await makeAPICall('deleteAbsensi', {
                    tanggal: tanggal,
                    ekstra: ekstra,
                    kelas: kelas,
                    nama: nama
                });
                showNotification('Data absensi berhasil dihapus', 'success');
                loadAbsensiData();
            } catch (error) {
                // Error already handled in makeAPICall
            }
        }

        function editPenilaian(ekstra, kelas, nama, nilai, keterangan) {
            showPenilaianModal({ ekstra, kelas, nama, nilai, keterangan });
        }

        async function deletePenilaian(ekstra, kelas, nama) {
            // Show inline confirmation instead of browser confirm
            const confirmModal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg shadow-lg max-w-md w-full mx-4">
                        <div class="p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Konfirmasi Hapus</h3>
                            <p class="text-gray-600 mb-6">Apakah Anda yakin ingin menghapus data penilaian <strong>${nama}</strong> dari ekstrakurikuler <strong>${ekstra}</strong>?</p>
                            <div class="flex justify-end space-x-3">
                                <button onclick="closeModal()" 
                                        class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                                    Batal
                                </button>
                                <button onclick="confirmDeletePenilaian('${ekstra}', '${kelas}', '${nama}')" 
                                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                                    Hapus
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-container').innerHTML = confirmModal;
        }

        async function confirmDeletePenilaian(ekstra, kelas, nama) {
            closeModal();
            
            try {
                await makeAPICall('deletePenilaian', {
                    ekstra: ekstra,
                    kelas: kelas,
                    nama: nama
                });
                showNotification('Data penilaian berhasil dihapus', 'success');
                loadPenilaianData();
            } catch (error) {
                // Error already handled in makeAPICall
            }
        }

        // Laporan functions
        async function loadLaporanData() {
            // Initialize filter options when laporan tab is opened
            updateLaporanFilterOptions();
            
            // Set default date range (last 30 days)
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
            
            document.getElementById('laporan-tanggal-akhir').value = today.toISOString().split('T')[0];
            document.getElementById('laporan-tanggal-mulai').value = thirtyDaysAgo.toISOString().split('T')[0];
        }

        function updateLaporanFilterOptions() {
            const filterType = document.getElementById('laporan-filter-type').value;
            const filterValueSelect = document.getElementById('laporan-filter-value');
            
            // Clear existing options
            filterValueSelect.innerHTML = '<option value="">Pilih...</option>';
            
            let options = [];
            
            if (filterType === 'kelas') {
                // Get unique kelas from anggota data
                const kelasSet = new Set();
                anggotaData.forEach(item => {
                    if (item.kelas) kelasSet.add(item.kelas);
                });
                options = Array.from(kelasSet).sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }));
            } else if (filterType === 'ekstra') {
                // Get unique ekstra from anggota data
                const ekstraSet = new Set();
                anggotaData.forEach(item => {
                    if (item.ekstra) ekstraSet.add(item.ekstra);
                });
                options = Array.from(ekstraSet).sort();
            }
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                filterValueSelect.appendChild(optionElement);
            });
        }

        async function generateLaporan() {
            const filterType = document.getElementById('laporan-filter-type').value;
            const filterValue = document.getElementById('laporan-filter-value').value;
            const tanggalMulai = document.getElementById('laporan-tanggal-mulai').value;
            const tanggalAkhir = document.getElementById('laporan-tanggal-akhir').value;
            
            if (!filterValue) {
                showNotification('Silakan pilih kelas atau ekstrakurikuler', 'error');
                return;
            }
            
            if (!tanggalMulai || !tanggalAkhir) {
                showNotification('Silakan pilih rentang tanggal', 'error');
                return;
            }
            
            if (new Date(tanggalMulai) > new Date(tanggalAkhir)) {
                showNotification('Tanggal mulai tidak boleh lebih besar dari tanggal akhir', 'error');
                return;
            }
            
            try {
                showLoading(true);
                
                console.log('üîÑ Mengambil data absensi terbaru dari server...');
                
                // PENTING: Selalu ambil data absensi terbaru dari server
                const absensiResult = await makeAPICall('getAbsensi');
                const serverAbsensiData = absensiResult.data || [];
                
                console.log(`‚úÖ Berhasil mengambil ${serverAbsensiData.length} data absensi dari server`);
                
                // Filter anggota data based on selected criteria
                let filteredAnggota = [];
                if (filterType === 'kelas') {
                    filteredAnggota = anggotaData.filter(item => item.kelas === filterValue);
                } else if (filterType === 'ekstra') {
                    filteredAnggota = anggotaData.filter(item => item.ekstra === filterValue);
                }
                
                if (filteredAnggota.length === 0) {
                    showNotification('Tidak ada anggota yang sesuai dengan filter', 'error');
                    return;
                }
                
                console.log(`üìã Ditemukan ${filteredAnggota.length} anggota untuk ${filterType}: ${filterValue}`);
                
                // Filter absensi data based on date range and members
                const filteredAbsensi = serverAbsensiData.filter(item => {
                    const itemDate = new Date(item.tanggal);
                    const startDate = new Date(tanggalMulai);
                    const endDate = new Date(tanggalAkhir);
                    
                    const dateInRange = itemDate >= startDate && itemDate <= endDate;
                    const memberMatch = filteredAnggota.some(anggota => 
                        anggota.nama === item.nama && 
                        anggota.kelas === item.kelas &&
                        anggota.ekstra === item.ekstra
                    );
                    
                    return dateInRange && memberMatch;
                });
                
                console.log(`üìÖ Data absensi dalam rentang tanggal: ${filteredAbsensi.length} records`);
                
                // Get unique dates in the range, sorted from oldest to newest (ascending)
                const dateSet = new Set();
                filteredAbsensi.forEach(item => dateSet.add(item.tanggal));
                const sortedDates = Array.from(dateSet).sort((a, b) => new Date(a) - new Date(b));
                
                console.log(`üìÜ Tanggal unik terurut (${sortedDates.length}):`, sortedDates);
                
                // Build laporan data
                laporanData = filteredAnggota.map(anggota => {
                    const rekapKehadiran = {};
                    const totals = { H: 0, S: 0, I: 0, A: 0 };
                    
                    // Initialize all dates with empty status
                    sortedDates.forEach(date => {
                        rekapKehadiran[date] = '-';
                    });
                    
                    // Fill in actual attendance data and count totals
                    filteredAbsensi.forEach(absensi => {
                        if (absensi.nama === anggota.nama && 
                            absensi.kelas === anggota.kelas &&
                            absensi.ekstra === anggota.ekstra) {
                            
                            // Set attendance status for the date
                            rekapKehadiran[absensi.tanggal] = absensi.status;
                            
                            // Count totals based on status
                            const status = absensi.status;
                            if (status === 'H') {
                                totals.H++;
                            } else if (status === 'S') {
                                totals.S++;
                            } else if (status === 'I') {
                                totals.I++;
                            } else if (status === 'A') {
                                totals.A++;
                            }
                        }
                    });
                    
                    return {
                        nama: anggota.nama,
                        kelas: anggota.kelas,
                        ekstra: anggota.ekstra,
                        kehadiran: rekapKehadiran,
                        totals: totals,
                        sortedDates: sortedDates
                    };
                });
                
                // Sort laporan data by kelas then nama
                laporanData.sort((a, b) => {
                    if (a.kelas !== b.kelas) {
                        return a.kelas.localeCompare(b.kelas, undefined, { numeric: true, sensitivity: 'base' });
                    }
                    return a.nama.localeCompare(b.nama, 'id', { sensitivity: 'base' });
                });
                
                filteredLaporanData = [...laporanData];
                currentLaporanPage = 1;
                
                renderLaporanTable();
                
                // Update info dengan detail debug
                const info = `${filterType === 'kelas' ? 'Kelas' : 'Ekstrakurikuler'}: ${filterValue} | ${tanggalMulai} s/d ${tanggalAkhir} | ${laporanData.length} siswa | ${filteredAbsensi.length} data absensi | ${sortedDates.length} hari`;
                document.getElementById('laporan-info').textContent = info;
                
                // Show table, hide empty state
                document.getElementById('laporan-table-container').classList.remove('hidden');
                document.getElementById('laporan-empty-state').classList.add('hidden');
                
                showNotification(`‚úÖ Laporan berhasil dibuat! ${laporanData.length} siswa, ${filteredAbsensi.length} data absensi, ${sortedDates.length} hari kehadiran`, 'success');
                
            } catch (error) {
                console.error('‚ùå Error generate laporan:', error);
                showNotification('Gagal membuat laporan: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function renderLaporanTable() {
            if (laporanData.length === 0) {
                document.getElementById('laporan-table-container').classList.add('hidden');
                document.getElementById('laporan-empty-state').classList.remove('hidden');
                return;
            }
            
            const thead = document.getElementById('laporan-table-head');
            const tbody = document.getElementById('laporan-table-body');
            
            // Get dates from first record (all records have same dates)
            const dates = laporanData[0] && laporanData[0].sortedDates ? laporanData[0].sortedDates : [];
            
            // Build table header
            let headerHTML = `
                <tr>
                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50 z-10 border-r border-gray-200">Nama</th>
                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200">Kelas</th>
                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200">Ekstra</th>
            `;
            
            // Add date columns (sorted from oldest to newest)
            dates.forEach(date => {
                const formattedDate = new Date(date).toLocaleDateString('id-ID', { 
                    day: '2-digit', 
                    month: '2-digit' 
                });
                headerHTML += `<th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[50px] border-r border-gray-200">${formattedDate}</th>`;
            });
            
            // Add total columns with separator
            headerHTML += `
                    <th class="px-3 py-3 text-center text-xs font-medium text-green-600 uppercase tracking-wider bg-green-50 border-l-2 border-green-200">Total H</th>
                    <th class="px-3 py-3 text-center text-xs font-medium text-yellow-600 uppercase tracking-wider bg-yellow-50">Total S</th>
                    <th class="px-3 py-3 text-center text-xs font-medium text-blue-600 uppercase tracking-wider bg-blue-50">Total I</th>
                    <th class="px-3 py-3 text-center text-xs font-medium text-red-600 uppercase tracking-wider bg-red-50">Total A</th>
                </tr>
            `;
            
            thead.innerHTML = headerHTML;
            
            // Build table body with pagination
            const startIndex = (currentLaporanPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const pageData = filteredLaporanData.slice(startIndex, endIndex);
            
            if (pageData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${3 + dates.length + 4}" class="px-6 py-8 text-center text-gray-500">
                            Tidak ada data laporan
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = pageData.map(item => {
                    let rowHTML = `
                        <tr class="hover:bg-gray-50 fade-in border-b border-gray-100">
                            <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900 sticky left-0 bg-white border-r border-gray-200">${item.nama}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500 border-r border-gray-200">${item.kelas}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500 border-r border-gray-200">${item.ekstra}</td>
                    `;
                    
                    // Add attendance data for each date (sorted from oldest to newest)
                    dates.forEach(date => {
                        const status = item.kehadiran && item.kehadiran[date] ? item.kehadiran[date] : '-';
                        let statusClass = 'text-gray-400';
                        let bgClass = '';
                        
                        switch(status) {
                            case 'H':
                                statusClass = 'text-white font-bold';
                                bgClass = 'bg-green-500';
                                break;
                            case 'S':
                                statusClass = 'text-white font-bold';
                                bgClass = 'bg-yellow-500';
                                break;
                            case 'I':
                                statusClass = 'text-white font-bold';
                                bgClass = 'bg-blue-500';
                                break;
                            case 'A':
                                statusClass = 'text-white font-bold';
                                bgClass = 'bg-red-500';
                                break;
                            default:
                                statusClass = 'text-gray-400';
                                bgClass = 'bg-gray-100';
                        }
                        
                        rowHTML += `<td class="px-2 py-4 text-center text-sm ${statusClass} ${bgClass} border-r border-gray-200">${status}</td>`;
                    });
                    
                    // Add totals with separator
                    const totals = item.totals || { H: 0, S: 0, I: 0, A: 0 };
                    rowHTML += `
                            <td class="px-3 py-4 text-center text-sm font-bold text-green-700 bg-green-100 border-l-2 border-green-200">${totals.H}</td>
                            <td class="px-3 py-4 text-center text-sm font-bold text-yellow-700 bg-yellow-100">${totals.S}</td>
                            <td class="px-3 py-4 text-center text-sm font-bold text-blue-700 bg-blue-100">${totals.I}</td>
                            <td class="px-3 py-4 text-center text-sm font-bold text-red-700 bg-red-100">${totals.A}</td>
                        </tr>
                    `;
                    
                    return rowHTML;
                }).join('');
            }
            
            updateLaporanPagination(filteredLaporanData.length);
        }

        function updateLaporanPagination(totalItems) {
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            const startItem = (currentLaporanPage - 1) * ITEMS_PER_PAGE + 1;
            const endItem = Math.min(currentLaporanPage * ITEMS_PER_PAGE, totalItems);

            document.getElementById('laporan-showing').textContent = totalItems > 0 ? `${startItem}-${endItem}` : '0';
            document.getElementById('laporan-total').textContent = totalItems;

            document.getElementById('laporan-prev').disabled = currentLaporanPage <= 1;
            document.getElementById('laporan-next').disabled = currentLaporanPage >= totalPages;
        }

        function changeLaporanPage(direction) {
            const totalPages = Math.ceil(filteredLaporanData.length / ITEMS_PER_PAGE);
            const newPage = currentLaporanPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentLaporanPage = newPage;
                renderLaporanTable();
            }
        }

        function exportLaporan() {
            if (laporanData.length === 0) {
                showNotification('Tidak ada data laporan untuk diekspor', 'error');
                return;
            }
            
            try {
                // Get dates from first record
                const dates = laporanData[0].sortedDates || [];
                
                // Build clean table content for copy-paste (tab-delimited)
                let tableContent = '';
                
                // Header row
                let headers = ['Nama', 'Kelas', 'Ekstrakurikuler'];
                dates.forEach(date => {
                    const formattedDate = new Date(date).toLocaleDateString('id-ID', { 
                        day: '2-digit', 
                        month: '2-digit',
                        year: 'numeric'
                    });
                    headers.push(formattedDate);
                });
                headers.push('Total H', 'Total S', 'Total I', 'Total A');
                
                // Add header to content
                tableContent += headers.join('\t') + '\n';
                
                // Data rows - ensure clean data without any code
                laporanData.forEach(item => {
                    let row = [];
                    
                    // Basic info
                    row.push(String(item.nama || '').trim());
                    row.push(String(item.kelas || '').trim());
                    row.push(String(item.ekstra || '').trim());
                    
                    // Add attendance data for each date
                    dates.forEach(date => {
                        const status = item.kehadiran && item.kehadiran[date] ? String(item.kehadiran[date]).trim() : '-';
                        row.push(status);
                    });
                    
                    // Add totals as numbers
                    const totals = item.totals || { H: 0, S: 0, I: 0, A: 0 };
                    row.push(String(totals.H || 0));
                    row.push(String(totals.S || 0));
                    row.push(String(totals.I || 0));
                    row.push(String(totals.A || 0));
                    
                    // Join with tabs and add to content
                    tableContent += row.join('\t') + '\n';
                });
                
                console.log('üìä Export content prepared:', tableContent.substring(0, 200) + '...');
                
                // Show export modal with copyable table
                showExportModal(tableContent, headers, dates);
                
            } catch (error) {
                console.error('‚ùå Export error:', error);
                showNotification('Gagal membuat tabel export: ' + error.message, 'error');
            }
        }

        function showExportModal(tableContent, headers, dates) {
            const filterType = document.getElementById('laporan-filter-type').value;
            const filterValue = document.getElementById('laporan-filter-value').value;
            const tanggalMulai = document.getElementById('laporan-tanggal-mulai').value;
            const tanggalAkhir = document.getElementById('laporan-tanggal-akhir').value;
            
            const modalHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg shadow-lg max-w-6xl w-full mx-4 max-h-[90vh] overflow-hidden">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">Export Laporan ke Excel</h3>
                                    <p class="text-sm text-gray-600 mt-1">
                                        ${filterType === 'kelas' ? 'Kelas' : 'Ekstrakurikuler'}: ${filterValue} | 
                                        ${tanggalMulai} s/d ${tanggalAkhir} | 
                                        ${laporanData.length} siswa
                                    </p>
                                </div>
                                <button onclick="closeModal()" 
                                        class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                                    √ó
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <div class="mb-4 flex justify-between items-center">
                                <div class="text-sm text-gray-600">
                                    <p class="font-medium mb-2">üìã Cara menggunakan:</p>
                                    <ol class="list-decimal list-inside space-y-1 text-xs">
                                        <li>Klik tombol "Copy Tabel" di bawah</li>
                                        <li>Buka Microsoft Excel atau Google Sheets</li>
                                        <li>Paste (Ctrl+V) di cell A1</li>
                                        <li>Data akan otomatis tersusun dalam kolom yang rapi</li>
                                    </ol>
                                </div>
                                <button id="copy-table-btn" 
                                        class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center space-x-2">
                                    <span>üìã</span>
                                    <span>Copy Tabel</span>
                                </button>
                            </div>
                            
                            <!-- Preview Table -->
                            <div class="border border-gray-300 rounded-lg overflow-hidden">
                                <div class="bg-gray-50 px-4 py-2 border-b border-gray-300">
                                    <h4 class="text-sm font-medium text-gray-700">Preview Tabel (${laporanData.length} baris)</h4>
                                </div>
                                <div class="overflow-auto max-h-96">
                                    <table class="min-w-full text-xs">
                                        <thead class="bg-gray-100 sticky top-0">
                                            <tr>
                                                ${headers.map(header => `<th class="px-2 py-2 text-left font-medium text-gray-700 border-r border-gray-200 whitespace-nowrap">${header}</th>`).join('')}
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white">
                                            ${laporanData.map(item => {
                                                let row = `<tr class="border-b border-gray-100 hover:bg-gray-50">`;
                                                row += `<td class="px-2 py-2 border-r border-gray-200 font-medium">${item.nama}</td>`;
                                                row += `<td class="px-2 py-2 border-r border-gray-200">${item.kelas}</td>`;
                                                row += `<td class="px-2 py-2 border-r border-gray-200">${item.ekstra}</td>`;
                                                
                                                // Add attendance data
                                                dates.forEach(date => {
                                                    const status = item.kehadiran[date] || '-';
                                                    let statusClass = '';
                                                    switch(status) {
                                                        case 'H': statusClass = 'bg-green-100 text-green-800'; break;
                                                        case 'S': statusClass = 'bg-yellow-100 text-yellow-800'; break;
                                                        case 'I': statusClass = 'bg-blue-100 text-blue-800'; break;
                                                        case 'A': statusClass = 'bg-red-100 text-red-800'; break;
                                                        default: statusClass = 'text-gray-400';
                                                    }
                                                    row += `<td class="px-2 py-2 border-r border-gray-200 text-center ${statusClass}">${status}</td>`;
                                                });
                                                
                                                // Add totals
                                                row += `<td class="px-2 py-2 border-r border-gray-200 text-center font-bold text-green-700">${item.totals.H}</td>`;
                                                row += `<td class="px-2 py-2 border-r border-gray-200 text-center font-bold text-yellow-700">${item.totals.S}</td>`;
                                                row += `<td class="px-2 py-2 border-r border-gray-200 text-center font-bold text-blue-700">${item.totals.I}</td>`;
                                                row += `<td class="px-2 py-2 text-center font-bold text-red-700">${item.totals.A}</td>`;
                                                row += `</tr>`;
                                                return row;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Hidden textarea for copying -->
                            <textarea id="copy-content" class="hidden w-full p-2 border border-gray-300 rounded font-mono text-xs" readonly style="display: none;">${tableContent}</textarea>
                            
                            <div class="mt-4 flex justify-end space-x-3">
                                <button onclick="closeModal()" 
                                        class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                                    Tutup
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('modal-container').innerHTML = modalHTML;

            // Setup copy functionality
            document.getElementById('copy-table-btn').addEventListener('click', async () => {
                try {
                    console.log('üîÑ Starting copy process...');
                    
                    // Get the clean table content
                    const cleanContent = tableContent.trim();
                    console.log('üìã Content to copy (first 100 chars):', cleanContent.substring(0, 100));
                    
                    // Try using modern clipboard API first
                    if (navigator.clipboard && window.isSecureContext) {
                        await navigator.clipboard.writeText(cleanContent);
                        console.log('‚úÖ Copied using modern clipboard API');
                        showCopySuccess();
                    } else {
                        // Fallback for older browsers
                        const textarea = document.getElementById('copy-content');
                        textarea.value = cleanContent; // Ensure clean content
                        textarea.style.display = 'block'; // Make visible temporarily
                        textarea.select();
                        textarea.setSelectionRange(0, 99999);
                        
                        const successful = document.execCommand('copy');
                        textarea.style.display = 'none'; // Hide again
                        
                        if (successful) {
                            console.log('‚úÖ Copied using fallback method');
                            showCopySuccess();
                        } else {
                            throw new Error('Copy command failed');
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Copy failed:', error);
                    
                    // Show manual copy option
                    const textarea = document.getElementById('copy-content');
                    textarea.style.display = 'block';
                    textarea.style.height = '200px';
                    textarea.select();
                    
                    showNotification('Copy otomatis gagal. Silakan select all (Ctrl+A) dan copy (Ctrl+C) dari kotak teks yang muncul.', 'error');
                }
            });
            
            function showCopySuccess() {
                const btn = document.getElementById('copy-table-btn');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<span>‚úÖ</span><span>Berhasil Disalin!</span>';
                btn.className = 'bg-green-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center space-x-2';
                
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.className = 'bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center space-x-2';
                }, 2000);
                
                showNotification('‚úÖ Tabel berhasil disalin! Sekarang paste (Ctrl+V) di Excel atau Google Sheets', 'success');
            }
        }

        // Utility functions
        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.className = `mb-6 p-4 rounded-lg ${type === 'success' ? 'bg-green-100 text-green-800' : 
                                                           type === 'error' ? 'bg-red-100 text-red-800' : 
                                                           'bg-blue-100 text-blue-800'}`;
            notification.textContent = message;
            notification.classList.remove('hidden');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 5000);
        }
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9979586ee745ec6b',t:'MTc2MTk3ODY0Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>

</html>
